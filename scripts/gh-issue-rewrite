#!/bin/bash

# Usage: ./script.sh [--dry-run]

dry_run=false
if [[ "$1" == "--dry-run" ]]; then
    dry_run=true
    echo "Running in DRY RUN mode - no changes will be made"
    echo "----------------------------------------"
fi

get_linked_issues() {
    gh issue view 13069 --json body -q .body |
    grep -o '#[0-9]\+' |
    sed 's/#//'
}

update_issue_title() {
    local issue_number=$1
    local current_title=$(gh issue view $issue_number --json title -q .title)
    local new_title=$(echo "$current_title" | sed 's/ (Upgrade 12)$//' | sed 's/$/ (Upgrade 13)/')

    local issue_url=$(gh issue view $issue_number --json url -q .url)
    echo "Issue URL: $issue_url"
    echo "Current title: $current_title"
    echo "New title: $new_title"

    if [ "$dry_run" = false ]; then
        gh issue edit $issue_number --title "$new_title"
        echo "âœ“ Updated"
    fi
    echo "----------------------------------------"
}

echo "Fetching linked issues from #13069..."
linked_issues=$(get_linked_issues)

if [ -z "$linked_issues" ]; then
    echo "No linked issues found in #13069"
    exit 1
fi

echo "Found linked issues. Starting title updates..."
echo "----------------------------------------"

for issue in $linked_issues; do
    update_issue_title $issue
done

if [ "$dry_run" = true ]; then
    echo "Dry run completed. Run without --dry-run to apply changes."
else
    echo "Title update process completed!"
fi
